{% extends 'base.html' %}

{% block title %}LocalBriefing - ì„¤ì •{% endblock %}

{% block content %}
<div class="settings-header">
    <div class="settings-logo">âš™ï¸ ì„¤ì •</div>
    <div class="settings-subtitle">ë‚´ ë¸Œë¦¬í•‘ì„ ë§ì¶¤ ì„¤ì •í•˜ì„¸ìš”</div>
</div>

<form id="settingsForm" method="post">
    {% csrf_token %}
    
    <div class="settings-bento">
        <!-- Account Section -->
        <div class="settings-card account-card">
            <div class="glass-card">
                <div class="card-header-minimal">
                    <span class="clay-icon">ğŸ‘¤</span>
                    <span class="card-title-bold">ê³„ì • ì •ë³´</span>
                </div>
                <div class="account-info">
                    <div class="info-item">
                        <span class="info-label">ì´ë©”ì¼</span>
                        <span class="info-value">{{ user_email|default:'user@example.com' }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ê°€ì…ì¼</span>
                        <span class="info-value">2024.03.01</span>
                    </div>
                    <button type="button" class="clay-btn secondary small">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                </div>
            </div>
        </div>

        <!-- Location Section -->
        <div class="settings-card location-card">
            <div class="glass-card">
                <div class="card-header-minimal">
                    <span class="clay-icon">ğŸ“</span>
                    <span class="card-title-bold">ê±°ì£¼ì§€</span>
                </div>
                <div class="location-display">
                    <div class="current-location">
                        <span class="location-text">{{ district|default:'ê°•ë‚¨êµ¬' }}</span>
                    </div>
                    <button type="button" class="clay-btn primary small" onclick="openLocationModal()">ë³€ê²½</button>
                </div>
            </div>
        </div>

        <!-- Categories Section -->
        <div class="settings-card categories-card">
            <div class="glass-card">
                <div class="card-header-minimal">
                    <span class="clay-icon">ğŸ“‹</span>
                    <span class="card-title-bold">ë¸Œë¦¬í•‘ ì¹´í…Œê³ ë¦¬</span>
                </div>
                <div class="categories-grid">
                    <div class="category-toggle">
                        <div class="toggle-info">
                            <span class="toggle-icon">â˜€ï¸</span>
                            <span class="toggle-label">ë‚ ì”¨ ì •ë³´</span>
                        </div>
                        <div class="toggle-switch {% if categories.weather %}active{% endif %}" onclick="toggleSwitch(this)" data-name="weather"></div>
                    </div>
                    <div class="category-toggle">
                        <div class="toggle-info">
                            <span class="toggle-icon">ğŸ“¢</span>
                            <span class="toggle-label">êµ¬ì²­ ì†Œì‹</span>
                        </div>
                        <div class="toggle-switch {% if categories.district_news %}active{% endif %}" onclick="toggleSwitch(this)" data-name="district_news"></div>
                    </div>
                    <div class="category-toggle">
                        <div class="toggle-info">
                            <span class="toggle-icon">ğŸ’¬</span>
                            <span class="toggle-label">ë™ë„¤ ì´ìŠˆ</span>
                        </div>
                        <div class="toggle-switch {% if categories.community %}active{% endif %}" onclick="toggleSwitch(this)" data-name="community"></div>
                    </div>
                    <div class="category-toggle">
                        <div class="toggle-info">
                            <span class="toggle-icon">ğŸ½ï¸</span>
                            <span class="toggle-label">ë§›ì§‘ ì •ë³´</span>
                        </div>
                        <div class="toggle-switch {% if categories.restaurants %}active{% endif %}" onclick="toggleSwitch(this)" data-name="restaurants"></div>
                    </div>
                    <div class="category-toggle">
                        <div class="toggle-info">
                            <span class="toggle-icon">ğŸ†•</span>
                            <span class="toggle-label">ì‹ ì¥ ê°œì—… ìŒì‹ì </span>
                        </div>
                        <div class="toggle-switch {% if categories.new_restaurants %}active{% endif %}" onclick="toggleSwitch(this)" data-name="new_restaurants"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications Section -->
        <div class="settings-card notifications-card">
            <div class="glass-card">
                <div class="card-header-minimal">
                    <span class="clay-icon">ğŸ””</span>
                    <span class="card-title-bold">ì•Œë¦¼ ì„¤ì •</span>
                </div>
                <div class="notification-settings">
                    <div class="time-selector">
                        <span class="setting-label">ë¸Œë¦¬í•‘ ì‹œê°„</span>
                        <select name="notification_time" class="form-select modern compact">
                            <option value="06:00" {% if notification_time == '06:00' %}selected{% endif %}>ì˜¤ì „ 6:00</option>
                            <option value="07:00" {% if notification_time == '07:00' or not notification_time %}selected{% endif %}>ì˜¤ì „ 7:00</option>
                            <option value="08:00" {% if notification_time == '08:00' %}selected{% endif %}>ì˜¤ì „ 8:00</option>
                            <option value="09:00" {% if notification_time == '09:00' %}selected{% endif %}>ì˜¤ì „ 9:00</option>
                            <option value="10:00" {% if notification_time == '10:00' %}selected{% endif %}>ì˜¤ì „ 10:00</option>
                        </select>
                    </div>
                    <div class="category-toggle">
                        <div class="toggle-info">
                            <span class="toggle-icon">ğŸ…</span>
                            <span class="toggle-label">ì£¼ë§ ì•Œë¦¼</span>
                        </div>
                        <div class="toggle-switch {% if weekend_notifications %}active{% endif %}" onclick="toggleSwitch(this)" data-name="weekend_notifications"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Other Settings -->
        <div class="settings-card other-card">
            <div class="glass-card">
                <div class="card-header-minimal">
                    <span class="clay-icon">â„¹ï¸</span>
                    <span class="card-title-bold">ê¸°íƒ€</span>
                </div>
                <div class="other-options">
                    <div class="option-item">
                        <span class="option-text">ì´ìš©ì•½ê´€</span>
                        <span class="option-arrow">â€º</span>
                    </div>
                    <div class="option-item">
                        <span class="option-text">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</span>
                        <span class="option-arrow">â€º</span>
                    </div>
                    <div class="option-item">
                        <span class="option-text">ë¬¸ì˜í•˜ê¸°</span>
                        <span class="option-arrow">â€º</span>
                    </div>
                    <div class="option-item logout">
                        <span class="option-text">ë¡œê·¸ì•„ì›ƒ</span>
                        <span class="option-arrow">â€º</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="settings-actions">
        <button type="submit" class="clay-btn primary large">
            <span class="btn-icon">ğŸ’¾</span>
            <span>ì„¤ì • ì €ì¥</span>
        </button>
        <button type="button" class="clay-btn secondary large" onclick="location.href='/briefing/'">
            <span class="btn-icon">â†</span>
            <span>ë¸Œë¦¬í•‘ìœ¼ë¡œ</span>
        </button>
    </div>
</form>

<!-- ìœ„ì¹˜ ë³€ê²½ ëª¨ë‹¬ -->
<div id="locationModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ“ ê±°ì£¼ì§€ ë³€ê²½</h3>
            <span class="close" onclick="closeLocationModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>êµ¬ ì„ íƒ</label>
                <select id="districtSelect">
                    <option value="">êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeLocationModal()">ì·¨ì†Œ</button>
            <button type="button" class="btn btn-primary" onclick="saveLocation()">ì €ì¥</button>
        </div>
    </div>
</div>

<script>
// í† ê¸€ ìŠ¤ìœ„ì¹˜ ê¸°ëŠ¥
function toggleSwitch(element) {
    element.classList.toggle('active');
}

// ìœ„ì¹˜ ë³€ê²½ ëª¨ë‹¬
function openLocationModal() {
    document.getElementById('locationModal').style.display = 'block';
    loadDistricts();
}

function closeLocationModal() {
    document.getElementById('locationModal').style.display = 'none';
}

// êµ¬ ëª©ë¡ ë¡œë“œ
function loadDistricts() {
    fetch('/api/districts/')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('districtSelect');
            select.innerHTML = '<option value="">êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            data.districts.forEach(district => {
                select.innerHTML += `<option value="${district}">${district}</option>`;
            });
        });
}



// ìœ„ì¹˜ ì €ì¥
function saveLocation() {
    const district = document.getElementById('districtSelect').value;
    
    if (!district) {
        alert('êµ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // í¼ì— ìˆ¨ê²¨ì§„ í•„ë“œ ì¶”ê°€
    const form = document.getElementById('settingsForm');
    
    let districtInput = document.querySelector('input[name="district"]');
    if (!districtInput) {
        districtInput = document.createElement('input');
        districtInput.type = 'hidden';
        districtInput.name = 'district';
        form.appendChild(districtInput);
    }
    districtInput.value = district;
    
    closeLocationModal();
    
    // í™”ë©´ì— ì¦‰ì‹œ ë°˜ì˜
    document.querySelector('.location-text').textContent = district;
}

// í¼ ì œì¶œ ì‹œ í† ê¸€ ìƒíƒœ ì²˜ë¦¬
document.getElementById('settingsForm').addEventListener('submit', function(e) {
    // ê¸°ì¡´ ìˆ¨ê²¨ì§„ ì…ë ¥ í•„ë“œ ì œê±°
    const existingInputs = this.querySelectorAll('input[type="hidden"][data-toggle]');
    existingInputs.forEach(input => input.remove());
    
    // í† ê¸€ ìŠ¤ìœ„ì¹˜ ìƒíƒœë¥¼ ìˆ¨ê²¨ì§„ ì…ë ¥ í•„ë“œë¡œ ì¶”ê°€
    const toggles = document.querySelectorAll('.toggle-switch[data-name]');
    toggles.forEach(toggle => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = toggle.dataset.name;
        input.value = toggle.classList.contains('active') ? 'on' : 'off';
        input.setAttribute('data-toggle', 'true');
        this.appendChild(input);
    });
});
</script>
{% endblock %}